<!DOCTYPE html> 
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Navalha Digital - MVP Barbearia (Login + Master) v0.8</title>

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { min-height: 100%; }
    body {
      background: url("minha-imagem.png") repeat;
      background-repeat: repeat !important;
      background-size: 200px !important;
      background-color: #0a0a0a !important;
      color: #fefce8;
    }
    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.94);
      z-index: 0;
      pointer-events: none;
    }
    #app, #auth-screen, header, main, section, footer { position: relative; z-index: 1; }
    .card { background-color:#111827; color:#facc15; }
    .btn-yellow { background-color:#facc15; color:#111827; }
    .btn-yellow:hover { background-color:#eab308; }
    input, select, textarea{
      background-color:#0b1220 !important; border:1px solid #374151 !important;
      color:#e5e7eb !important; border-radius:.5rem; padding:.5rem .75rem;
    }
    input::placeholder, textarea::placeholder { color:#9ca3af !important; }
    input:focus, select:focus, textarea:focus{
      outline:none !important; border-color:#eab308 !important;
      box-shadow:0 0 0 3px rgba(234,179,8,.25) !important;
    }
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; }
      body::after { display: none !important; }
      #print-area { display: block !important; }
      #app, header, main, footer { background: #fff !important; color: #111 !important; }
    }
  </style>
</head>

<body class="text-gray-100">
  <div class="overlay">

    <!-- ===================== AUTH SCREEN ===================== -->
    <section id="auth-screen" class="min-h-[80vh] flex items-center justify-center p-4">
      <div class="w-full max-w-md card rounded-2xl shadow border border-yellow-500/30 p-6">
        <h1 class="text-2xl font-bold text-yellow-400 text-center">Navalha Digital</h1>
        <p class="mt-1 text-center text-sm text-yellow-200/80">Acesse com seu e-mail e senha</p>
        <form id="auth-form" class="mt-5 space-y-3">
          <div>
            <label class="block text-sm text-yellow-200">E-mail</label>
            <input id="auth-email" type="email" placeholder="voce@exemplo.com" required class="w-full mt-1" />
          </div>
          <div>
            <label class="block text-sm text-yellow-200">Senha</label>
            <input id="auth-pass" type="password" placeholder="mín. 6 caracteres" minlength="6" required class="w-full mt-1" />
          </div>
          <div class="flex gap-2">
            <button id="btn-signin" type="submit" class="btn-yellow px-4 py-2 rounded w-full">Entrar</button>
            <button id="btn-signup" type="button" class="px-4 py-2 rounded w-full border border-yellow-500/40 text-yellow-300">Criar conta</button>
          </div>
          <div id="auth-msg" class="text-xs text-yellow-300"></div>
        </form>
      </div>
    </section>

    <!-- ===================== APP ===================== -->
    <div id="app" class="hidden">
      <header class="px-4 py-3 shadow border-b border-yellow-500/20">
        <div class="max-w-6xl mx-auto flex items-center justify-between">
          <h1 class="text-xl font-bold text-yellow-400">Navalha Digital</h1>
          <nav class="space-x-2 no-print flex items-center">
            <button class="tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="agendar">Agenda</button>
            <button class="tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="registrar">Registrar Corte</button>
            <button class="tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="caixa">Caixa</button>
            <button class="tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="relatorios">Relatórios</button>
            <button class="tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="config">Configurações</button>
            <button id="tab-admin-btn" class="hidden tab-btn px-3 py-1.5 rounded btn-yellow" data-tab="admin">Admin</button>
            <span id="tenant-badge" class="hidden ml-3 text-xs px-2 py-1 rounded border border-yellow-500/40 text-yellow-300"></span>
            <button id="btn-logout" class="ml-3 px-3 py-1.5 rounded border border-yellow-500/40 text-yellow-300">Sair</button>
          </nav>
        </div>
      </header>

      <main class="max-w-6xl mx-auto p-4 space-y-6">
        <div id="toast" class="hidden rounded-lg border border-yellow bg-black p-3 shadow text-yellow-400"></div>

        <!-- ============ as suas seções permanecem iguais ============ -->
        <!-- AGENDA, REGISTRAR, CAIXA, RELATÓRIOS, CONFIG, ADMIN ... -->
        <!-- (Conteúdo original das seções mantido) -->
      </main>

      <footer class="text-center text-xs text-yellow-400 py-6">Navalha Digital – Local First + Supabase. Versão 0.8</footer>
    </div>
  </div>

  <div id="print-area" class="hidden"></div>

  <script>
    // ========================= SUPABASE CONFIG =========================
    const SUPABASE_URL  = "https://xvrfpciqnuzxfsaktlja.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cmZwY2lxbnV6eGZzYWt0bGphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NjI1NjYsImV4cCI6MjA3MTEzODU2Nn0.JBmK1MnM8-8mjKq5bLHOh-9alHGTpCiXtsZnC-uFGlc";

    const MASTER_EMAILS = [ "jacivaldojr@gmail.com" ];

    function resolveSupabaseConfig(){
      const cfgUrl = localStorage.getItem('bb_cfg_supabase_url');
      const cfgKey = localStorage.getItem('bb_cfg_supabase_anon');
      const url = cfgUrl || SUPABASE_URL;
      const key = cfgKey || SUPABASE_ANON_KEY;
      return { url, key };
    }

    let supabase = null;
    function createSupabase(){
      const { url, key } = resolveSupabaseConfig();
      if (window.supabase?.createClient && url && key){
        supabase = window.supabase.createClient(url, key);
      } else {
        supabase = null;
      }
    }

    function sb(){ if (!supabase) throw new Error('Supabase não configurado'); return supabase; }
    function withTenant(q){ return activeTenantId ? q.eq('salon_id', activeTenantId) : q; }

    // ========================= STATE =========================
    let __user = null;
    let isMaster = false;
    let activeTenantId = null;
    let activeTenantName = null;
    let __tabsBound = false;
    let __salesRtChannel = null;

    function showApp(){ document.getElementById('app').classList.remove('hidden'); document.getElementById('auth-screen').classList.add('hidden'); }
    function hideApp(){ document.getElementById('app').classList.add('hidden'); document.getElementById('auth-screen').classList.remove('hidden'); }

    async function bootstrapAuth(){
      createSupabase();
      if (!supabase){
        document.getElementById('auth-msg').textContent =
          'Cole a URL e a anon key de Supabase nas Configurações e clique "Salvar e recarregar".';
        return;
      }

      const { data: { session } } = await supabase.auth.getSession();
      __user = session?.user || null;

      // ALTERADO: garantir profile universal no login
      if (__user) {
        await ensureProfileUniversal(); // cria/atualiza profile p/ qualquer usuário
      }

      computeRole();
      if (__user) showApp(); else hideApp();
      await initAfterAuth();
      setupRealtime(); // booking + caixa
      setupSalesRealtime(); // vendas realtime

      supabase.auth.onAuthStateChange(async (_evt, session)=>{
        __user = session?.user || null;
        if (__user) {
          await ensureProfileUniversal();
        }
        computeRole();
        if (__user) showApp(); else hideApp();
        initAfterAuth();
        setupRealtime();
        setupSalesRealtime();
      });
    }

    // ====================== TENANTS (apenas master) ======================
    const TENANTS_KEY = () => `bb_${__user?.id || 'anon'}_tenants`;
    function loadTenants(){ try{ return JSON.parse(localStorage.getItem(TENANTS_KEY())) || []; }catch(_){ return []; } }
    function saveTenants(list){ localStorage.setItem(TENANTS_KEY(), JSON.stringify(list)); }
    function slugify(str){ return (str||'').toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'').slice(0,40); }
    function randomId(n=5){ const abc='abcdefghijklmnopqrstuvwxyz0123456789'; let s=''; for(let i=0;i<n;i++) s+=abc[Math.floor(Math.random()*abc.length)]; return s; }

    function setActiveTenant(id, nome){
      activeTenantId = id; activeTenantName = nome || id;
      localStorage.setItem('bb_master_last_tenant', id);
      applyRoleUI();
      setupRealtime();
      setupSalesRealtime();
      refreshAll();
    }

    function applyRoleUI(){
      document.querySelector('#tab-admin-btn')?.classList.toggle('hidden', !isMaster);
      const badge = document.querySelector('#tenant-badge');
      if (isMaster && activeTenantId){ badge.classList.remove('hidden'); badge.textContent = `Cliente: ${activeTenantName}`; }
      else { badge.classList.add('hidden'); badge.textContent=''; }
    }

    function ensureDefaultTenantForMaster(){
      if (!isMaster) return;
      const list = loadTenants();
      if (list.length > 0) return;
      const id = `barbearia-jacivaldo-${randomId(5)}`;
      const nome = 'Barbearia do Jacivaldo';
      list.push({ id, nome });
      saveTenants(list);
      setActiveTenant(id, nome);
      toast('Cliente padrão criado e selecionado para o master.');
    }

    // ========================= ROLE / MASTER =========================
    function computeRole(){
      const email = (__user?.email || '').toLowerCase();
      isMaster = !!email && MASTER_EMAILS.map(e=>e.toLowerCase()).includes(email);

      if (!isMaster && __user?.user_metadata){
        const meta = __user.user_metadata || {};
        if (meta.salon_id){ activeTenantId = meta.salon_id; activeTenantName = meta.salon_name || meta.salon_id; }
        else { activeTenantId = null; activeTenantName = null; }
      } else if (isMaster){
        const last = localStorage.getItem('bb_master_last_tenant');
        const t = loadTenants().find(x=>x.id===last);
        if (t) setActiveTenant(t.id, t.nome);
        else { activeTenantId = null; activeTenantName = null; }
      } else {
        activeTenantId = null; activeTenantName = null;
      }

      ensureDefaultTenantForMaster();
      applyRoleUI();
    }

    // ========================= UTIL =========================
    const brl = (n) => (n || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const el = (sel, root=document) => root.querySelector(sel);
    const els = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    function toast(msg){ const t = el('#toast'); t.textContent = msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 1600); }

    // ===================== STORAGE (Local) =====================
    const STORE_KEYS = { BARBEIROS: 'barbeiros', SERVICOS: 'servicos', VENDAS: 'vendas', AGENDA: 'agenda', CLOSURES: 'caixa' };

    function currentScope(){
      if (isMaster) return activeTenantId || 'no-tenant';
      const salonId = __user?.user_metadata?.salon_id;
      if (salonId) return salonId;
      return __user?.id || 'anon';
    }

    const scopeKey = (k) => `bb_${currentScope()}_${k}`;

    const Storage = {
      get(k, fallback){ try{ return JSON.parse(localStorage.getItem(scopeKey(k))) ?? fallback; }catch(_){ return fallback; } },
      set(k, v){ localStorage.setItem(scopeKey(k), JSON.stringify(v)); },
      push(k, item){ const arr = Storage.get(k, []); arr.push(item); Storage.set(k, arr); return arr; },
      clear(){ Object.values(STORE_KEYS).forEach(k=>localStorage.removeItem(scopeKey(k))); }
    };

    function migrateAnonToCurrentScope(){
      const curPrefix  = `bb_${currentScope()}_`;
      const anonPrefix = `bb_anon_`;
      if (curPrefix === anonPrefix) return;
      Object.values(STORE_KEYS).forEach(k=>{
        const aKey = anonPrefix + k;
        const cKey = curPrefix  + k;
        const aVal = localStorage.getItem(aKey);
        if (aVal && !localStorage.getItem(cKey)) {
          localStorage.setItem(cKey, aVal);
        }
      });
    }

    function migrateUserIdToTenantScope(){
      if (isMaster) return;
      const tenant = __user?.user_metadata?.salon_id;
      const userId = __user?.id;
      if (!tenant || !userId) return;
      const userPrefix   = `bb_${userId}_`;
      const tenantPrefix = `bb_${tenant}_`;
      Object.values(STORE_KEYS).forEach(k=>{
        const uKey = userPrefix + k;
        const tKey = tenantPrefix + k;
        const uVal = localStorage.getItem(uKey);
        if (uVal && !localStorage.getItem(tKey)) {
          localStorage.setItem(tKey, uVal);
        }
      });
    }

    // ====================== DADOS PADRÃO ======================
    function seed(){
      if (typeof migrateAnonToCurrentScope === 'function') migrateAnonToCurrentScope();
      if (typeof migrateUserIdToTenantScope === 'function') migrateUserIdToTenantScope();

      if (isMaster && !activeTenantId) return;

      if (!Storage.get(STORE_KEYS.BARBEIROS)){
        Storage.set(STORE_KEYS.BARBEIROS, [
          { id: crypto.randomUUID(), nome: 'Lucas' },
          { id: crypto.randomUUID(), nome: 'Pedro' },
          { id: crypto.randomUUID(), nome: 'Saulo' },
        ]);
      }
      if (!Storage.get(STORE_KEYS.SERVICOS)){
        Storage.set(STORE_KEYS.SERVICOS, [
          { id: crypto.randomUUID(), nome: 'Corte disfarçado', valor: 35 },
          { id: crypto.randomUUID(), nome: 'Corte tesoura + máquina', valor: 40 },
          { id: crypto.randomUUID(), nome: 'Barba', valor: 25 },
          { id: crypto.randomUUID(), nome: 'Neviu', valor: 20 },
          { id: crypto.randomUUID(), nome: 'Corte navalhado', valor: 45 },
        ]);
      }
      if (!Storage.get(STORE_KEYS.VENDAS))  Storage.set(STORE_KEYS.VENDAS, []);
      if (!Storage.get(STORE_KEYS.AGENDA))  Storage.set(STORE_KEYS.AGENDA, []);
      if (!Storage.get(STORE_KEYS.CLOSURES)) Storage.set(STORE_KEYS.CLOSURES, []);
    }

    // =================== FUNÇÕES UNIVERSAIS DE PROFILE ===================
    // ALTERADO: solução para todos os usuários – garante profile + salon
    async function ensureProfileUniversal() {
      try {
        const { data: { user } } = await sb().auth.getUser();
        if (!user) return null;

        // Verifica se já existe profile com user_id
        let { data: prof, error: pErr } = await sb()
          .from('profiles')
          .select('user_id, salon_id, full_name, role')
          .eq('user_id', user.id)
          .maybeSingle();
        if (pErr) throw pErr;

        if (prof?.salon_id) return prof; // já está ok

        // Se não existe, criamos um salon padrão para o usuário
        // Você pode trocar por convite/seleção depois
        let salonId;
        // Tenta achar algum salon existente do usuário (opcional)
        // Caso não tenha tabela salons, pule a criação abaixo
        try {
          const { data: salon, error: sErr } = await sb()
            .from('salons')
            .insert({
              name: user.user_metadata?.display_name || user.email?.split('@')[0] || 'Meu Salão',
              owner_user_id: user.id
            })
            .select('id')
            .single();
          if (sErr) throw sErr;
          salonId = salon.id;
        } catch (e) {
          console.warn('Falha ao criar salon (ok se não existir tabela salons):', e?.message);
          // fallback: gera um UUID local para manter consistência
          // obs.: sem tabela salons, o valor só serve como chave do tenant
          salonId = crypto.randomUUID();
        }

        // Upsert do profile (obrigatório para a RLS funcionar)
        const { error: upErr } = await sb()
          .from('profiles')
          .upsert({
            user_id: user.id,                 // <- campo certo
            salon_id: salonId,
            full_name: user.user_metadata?.display_name || '',
            role: 'manager'
          }, { onConflict: 'user_id' });
        if (upErr) throw upErr;

        return { user_id: user.id, salon_id: salonId, full_name: user.user_metadata?.display_name || '', role: 'manager' };
      } catch (err) {
        console.error('ensureProfileUniversal error:', err);
        return null;
      }
    }

    // =================== TABS / RENDER (mesmo do seu código) ===================
    // ... suas funções activateTab, fillSelects, renderAgenda etc. continuam iguais ...

    // ================ AJUSTES CRÍTICOS: VENDAS E CAIXA =================

    // ALTERADO: buscar salon_id por profiles.user_id (não p.id)
    async function getSalonIdFromProfile() {
      const { data: { user } } = await sb().auth.getUser();
      if (!user) return null;
      const { data, error } = await sb()
        .from('profiles')
        .select('salon_id')
        .eq('user_id', user.id)    // <- ALTERADO
        .single();
      if (error) { console.error(error); return null; }
      return data?.salon_id || null;
    }

    // ALTERADO: registrar venda já usa salon_id correto
    async function registrarVenda({
      salonId,
      barberId = null,
      customerName,
      serviceName,
      priceReais,
      paymentType,
      notes = '',
      soldAt = new Date().toISOString(),
    }) {
      const price_cents = Math.round(Number(priceReais) * 100);
      const { data, error } = await sb()
        .from('sales')
        .insert([{
          salon_id: salonId,
          barber_id: barberId,
          customer_name: customerName,
          service_name: serviceName,
          price_cents,
          payment_type: paymentType,
          notes,
          sold_at: soldAt,
        }])
        .select('*')
        .single();
      if (error) throw error;
      return data;
    }

    async function listarVendasDoDiaServer(salonId, yyyy_mm_dd) {
      const inicio = new Date(yyyy_mm_dd); inicio.setHours(0,0,0,0);
      const fim = new Date(inicio); fim.setDate(inicio.getDate() + 1);
      const { data, error } = await sb()
        .from('sales')
        .select('*')
        .eq('salon_id', salonId)
        .gte('sold_at', inicio.toISOString())
        .lt('sold_at',  fim.toISOString())
        .order('sold_at', { ascending: true });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    // ... restante do bloco de VENDAS igual ao seu, chamando registrarVenda e listarVendasDoDiaServer ...

    // ============== CAIXA: fechar e salvar com policies por user_id ============
    async function getMySalonIdFromProfiles() {
      const { data: { user } } = await sb().auth.getUser();
      if (!user) throw new Error('Sem usuário');
      const { data, error } = await sb()
        .from('profiles')
        .select('salon_id')
        .eq('user_id', user.id)     // <- ALTERADO
        .single();
      if (error) throw error;
      return data.salon_id;
    }

    async function salvarFechamentoNoSupabase(closure) {
      if (!supabase) return null;
      const { data: { user } } = await sb().auth.getUser();
      if (!user) throw new Error('Sem usuário autenticado');
      const salonId = await getMySalonIdFromProfiles();
      if (!salonId) throw new Error('Perfil sem salon_id');

      const dateIso = closure.dataCaixa.includes('/') ? closure.dataCaixa.split('/').reverse().join('-') : closure.dataCaixa;

      const payload = {
        salon_id: salonId,
        operator_id: user.id,
        operator_email: user.email,
        date_yyyy_mm_dd: dateIso,
        nome_cliente: closure.nomeCliente,
        qtde: closure.qtde,
        pix: closure.pix,
        debito: closure.debito,
        credito: closure.credito,
        dinheiro: closure.dinheiro,
        total: closure.total,
        itens: closure.itens || []
      };

      const { data, error } = await sb()
        .from('caixa_fechamentos')
        .insert(payload)
        .select('*')
        .single();

      if (error) throw error;
      return data;
    }

    // =================== RESTO DO SEU CÓDIGO ORIGINAL ===================
    // Mantive suas funções de UI, realtime, prints, helpers, auth UI e init.
    // Para não alongar demais, o restante permanece igual ao que você enviou.

    // ======== Auth UI ========
    document.getElementById('auth-form')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if (!supabase){
        document.getElementById('auth-msg').textContent =
          'Cole a URL e a anon key nas Configurações e clique "Salvar e recarregar".';
        return;
      }
      const email = document.getElementById('auth-email').value.trim(); const password = document.getElementById('auth-pass').value;
      const msg = document.getElementById('auth-msg'); msg.textContent = 'Entrando...';
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error){ msg.textContent = 'Falha ao entrar: ' + error.message; return; }
      msg.textContent = 'Ok!';
    });

    document.getElementById('btn-signup')?.addEventListener('click', async ()=>{
      if (!supabase){
        document.getElementById('auth-msg').textContent =
          'Cole a URL e a anon key nas Configurações e clique "Salvar e recarregar".';
        return;
      }
      const email = document.getElementById('auth-email').value.trim();
      const password = document.getElementById('auth-pass').value;
      const msg = document.getElementById('auth-msg');
      if (!password || password.length < 6){
        msg.textContent = 'Informe uma senha com 6+ caracteres.';
        return;
      }
      msg.textContent = 'Criando conta...';
      const { error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          emailRedirectTo: `${window.location.origin}/#`
        }
      });
      if (error){ msg.textContent = 'Falha ao criar: ' + error.message; return; }
      msg.textContent = 'Conta criada! Entrando...';
      const { error: e2 } = await supabase.auth.signInWithPassword({ email, password });
      if (e2){ msg.textContent = 'Criou mas não entrou: ' + e2.message; return; }
      msg.textContent = 'Ok!';
    });

    document.getElementById('btn-logout')?.addEventListener('click', async ()=>{ if (!supabase) return; await supabase.auth.signOut(); });

    // ======== Config Supabase ========
    document.getElementById('cfg-sb-save')?.addEventListener('click', ()=>{
      const u = el('#cfg-sb-url').value.trim();
      const k = el('#cfg-sb-anon').value.trim();
      if (!u || !k){ toast('Informe URL e anon key.'); return; }
      localStorage.setItem('bb_cfg_supabase_url', u);
      localStorage.setItem('bb_cfg_supabase_anon', k);
      location.reload();
    });
    document.getElementById('cfg-sb-clear')?.addEventListener('click', ()=>{
      localStorage.removeItem('bb_cfg_supabase_url');
      localStorage.removeItem('bb_cfg_supabase_anon');
      toast('Config limpa. Recarregue a página.');
    });

    // =================== INICIALIZAÇÃO ===================
    async function refreshAll(){
      fillSelects();
      renderAgenda();
      renderVendas();
      renderRelatorios();
      renderBookingInbox();
      renderCaixa();
    }

    async function initAfterAuth(){
      if (typeof migrateAnonToCurrentScope === 'function') migrateAnonToCurrentScope();
      if (typeof migrateUserIdToTenantScope === 'function') migrateUserIdToTenantScope();

      seed();
      ensureDefaultTenantForMaster();
      refreshAll();

      if (!__tabsBound){
        els('.tab-btn').forEach(b=>b.addEventListener('click', ()=>activateTab(b.dataset.tab)));
        __tabsBound = true;
      }
      const vd = el('#vd-data'); if (vd) vd.value = new Date().toISOString().slice(0,10);
      if (isMaster && !activeTenantId) activateTab('admin'); else activateTab('agendar');
    }

    bootstrapAuth();
  </script>
</body>
</html>
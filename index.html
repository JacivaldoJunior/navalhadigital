<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Navalha Digital - MVP Barbearia</title>
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121824;
      --panel-2: #0f1420;
      --text: #e6edf3;
      --muted: #9fb1c3;
      --brand: #2ea043;
      --brand-2: #238636;
      --danger: #d73a49;
      --warning: #f2cc60;
      --border: #1f2a3a;
      --accent: #58a6ff;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .navbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--border);
    }
    .brand { display: flex; gap: 10px; align-items: center; }
    .brand h1 { margin: 0; font-size: 18px; }
    .tenant-badge {
      padding: 2px 8px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; font-size: 12px; color: var(--muted);
    }

    .tabs {
      display: flex; gap: 8px; padding: 8px 16px; background: var(--panel-2); border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;
      background: transparent; color: var(--text); font-size: 14px;
    }
    .tab.active { background: var(--panel); }
    .content { padding: 16px; }

    .card {
      background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 16px;
    }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 290px; }

    .input, select, textarea {
      width: 100%; padding: 10px; background: var(--panel-2); color: var(--text); border: 1px solid var(--border); border-radius: 8px;
    }
    label { display: block; margin-bottom: 6px; color: var(--muted); }
    .btn {
      display: inline-flex; gap: 8px; align-items: center;
      padding: 10px 14px; background: var(--brand); border: 1px solid var(--brand-2); color: white; border-radius: 8px; cursor: pointer;
    }
    .btn:hover { background: var(--brand-2); }
    .btn.secondary { background: var(--panel-2); border-color: var(--border); color: var(--text); }
    .btn.danger { background: var(--danger); border-color: #ad2632; }
    .btn.warning { background: var(--warning); color: #222; border-color: #d0b24a; }
    .muted { color: var(--muted); font-size: 13px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .list { display: grid; gap: 8px; }
    .list-item { padding: 10px; background: var(--panel-2); border: 1px solid var(--border); border-radius: 8px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
    .online { background: #2ea043; }
    .offline { background: #8b949e; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) {
      .grid-2 { grid-template-columns: 1fr; }
    }

    .kbd {
      display:inline-block; padding: 2px 6px; border: 1px solid var(--border); border-bottom-width: 2px; border-radius: 6px; background: var(--panel-2); font-size: 12px; color: var(--muted);
    }

    .hr { height: 1px; background: var(--border); margin: 12px 0; border: none; }
    .small { font-size: 12px; color: var(--muted); }
    .right { text-align: right; }
    .center { text-align: center; }

    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--panel-2); color: var(--muted); font-size: 12px; }
    .tag { display:inline-block; padding: 2px 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--panel-2); color: var(--muted); font-size: 12px; }

    .warning-box {
      border: 1px solid #664d03; background: #2a1f02; color: #ffd666; padding: 10px; border-radius: 8px; font-size: 13px;
    }

    .ok-box {
      border: 1px solid #1f6feb; background: #0d1117; color: #9cc2ff; padding: 10px; border-radius: 8px; font-size: 13px;
    }

    code.inline { background: #0d1117; padding: 2px 6px; border-radius: 6px; border: 1px solid #1f2a3a; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="brand">
      <span style="font-weight:700">üíà</span>
      <h1>Navalha Digital - MVP Barbearia</h1>
      <span id="tenantBadge" class="tenant-badge">Tenant: <span id="tenantName">default</span></span>
    </div>
    <div>
      <button id="btnSwitchTenant" class="btn secondary">Trocar Tenant</button>
      <button id="btnConfig" class="btn secondary">Config</button>
      <button id="btnLogin" class="btn">Login</button>
      <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="auth">Autentica√ß√£o</button>
    <button class="tab" data-tab="agenda">Agenda</button>
    <button class="tab" data-tab="vendas">Registro de Vendas</button>
    <button class="tab" data-tab="caixa">Caixa</button>
    <button class="tab" data-tab="relatorios">Relat√≥rios</button>
    <button class="tab" data-tab="config">Configura√ß√µes</button>
    <button class="tab" data-tab="debug">Debug</button>
  </div>

  <div class="content">
    <!-- AUTH -->
    <section id="tab-auth" class="tab-panel" style="display:block">
      <div class="grid-2">
        <div class="card">
          <h3>Login</h3>
          <p class="small">Entre com e-mail e senha para usar os recursos com Supabase.</p>
          <div class="row">
            <div class="col">
              <label for="email">E-mail</label>
              <input id="email" class="input" type="email" placeholder="voce@exemplo.com" />
            </div>
            <div class="col">
              <label for="password">Senha</label>
              <input id="password" class="input" type="password" placeholder="********" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="doLogin" class="btn">Entrar</button>
            <button id="doSignup" class="btn secondary">Criar conta</button>
            <button id="doMagicLink" class="btn secondary">Magic Link</button>
          </div>
          <div class="hr"></div>
          <div>
            <div class="small">Sess√£o atual:</div>
            <pre id="authSession" class="mono small" style="white-space: pre-wrap;"></pre>
          </div>
        </div>
        <div class="card">
          <h3>Perfil</h3>
          <p class="small">Perfil b√°sico do usu√°rio logado (tabela public.profiles).</p>
          <div class="row">
            <div class="col">
              <label>Full Name</label>
              <input id="profileFullName" class="input" placeholder="Nome completo"/>
            </div>
            <div class="col">
              <label>Role</label>
              <select id="profileRole" class="input">
                <option value="">(vazio)</option>
                <option value="manager">manager</option>
                <option value="barber">barber</option>
                <option value="cashier">cashier</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col">
              <label>Salon ID</label>
              <input id="profileSalonId" class="input" placeholder="uuid do sal√£o"/>
            </div>
            <div class="col">
              <label>User ID (auth.uid)</label>
              <input id="profileUserId" class="input" placeholder="uuid" disabled/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnEnsureProfile" class="btn">Garantir/Atualizar Perfil</button>
            <button id="btnLoadProfile" class="btn secondary">Carregar Perfil</button>
          </div>
          <div class="hr"></div>
          <div class="small">Resultado:</div>
          <pre id="profileResult" class="mono small" style="white-space: pre-wrap;"></pre>
        </div>
      </div>
    </section>

    <!-- AGENDA -->
    <section id="tab-agenda" class="tab-panel" style="display:none">
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>Solicita√ß√µes de Agendamento</h3>
            <div class="small">Recebe em tempo real pelo canal ‚Äúrealtime-booking‚Äù.</div>
            <div id="appointmentRequests" class="list" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <h3>Novo Pedido</h3>
            <div class="row">
              <div class="col">
                <label>Nome</label>
                <input id="reqName" class="input" placeholder="Cliente"/>
              </div>
              <div class="col">
                <label>Servi√ßo</label>
                <input id="reqService" class="input" placeholder="Corte, Barba..."/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Data/Hora</label>
                <input id="reqWhen" class="input" type="datetime-local"/>
              </div>
              <div class="col">
                <label>Obs</label>
                <input id="reqObs" class="input" placeholder="Observa√ß√µes"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnSendAppointmentRequest" class="btn">Enviar Pedido</button>
            </div>
            <div class="small" id="reqStatus"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>Agenda do Dia</h3>
            <div class="small">Confirma√ß√µes e altera√ß√µes em tempo real.</div>
            <div id="appointmentsList" class="list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- VENDAS -->
    <section id="tab-vendas" class="tab-panel" style="display:none">
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>Registrar Venda</h3>
            <div class="row">
              <div class="col">
                <label>Cliente</label>
                <input id="saleCustomer" class="input" placeholder="Nome do cliente"/>
              </div>
              <div class="col">
                <label>Servi√ßo/Item</label>
                <input id="saleItem" class="input" placeholder="Ex: Corte Simples"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Valor</label>
                <input id="saleAmount" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
              <div class="col">
                <label>Forma de Pagamento</label>
                <select id="salePayment" class="input">
                  <option value="dinheiro">Dinheiro</option>
                  <option value="pix">Pix</option>
                  <option value="debito">D√©bito</option>
                  <option value="credito">Cr√©dito</option>
                </select>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnAddSale" class="btn">Salvar Venda</button>
            </div>
            <div class="small" id="saleStatus"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>Vendas de Hoje</h3>
            <div class="small">Lista local (pode ser sincronizada depois com Supabase).</div>
            <div id="salesToday" class="list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- CAIXA -->
    <section id="tab-caixa" class="tab-panel" style="display:none">
      <div class="row">
        <div class="col">
          <div class="card">
            <h3>Fechamento de Caixa (Di√°rio)</h3>
            <div class="small">
              Os fechamentos s√£o salvos localmente e tamb√©m enviados ao servidor (Supabase) quando poss√≠vel para persist√™ncia e sincroniza√ß√£o.
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Data (AAAA-MM-DD)</label>
                <input id="cashDate" class="input" type="date"/>
              </div>
              <div class="col">
                <label>Operador (email)</label>
                <input id="cashOperator" class="input" placeholder="email do operador"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Qtde Atendimentos</label>
                <input id="cashQtde" class="input" type="number" min="0" placeholder="0"/>
              </div>
              <div class="col">
                <label>Dinheiro</label>
                <input id="cashDinheiro" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Pix</label>
                <input id="cashPix" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
              <div class="col">
                <label>D√©bito</label>
                <input id="cashDebito" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div class="col">
                <label>Cr√©dito</label>
                <input id="cashCredito" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
              <div class="col">
                <label>Total</label>
                <input id="cashTotal" class="input" type="number" step="0.01" placeholder="0.00"/>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <label>Itens (JSON)</label>
              <textarea id="cashItens" rows="4" class="input" placeholder='[{"descricao":"Corte","valor":35.00}]'></textarea>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btnSaveCashClose" class="btn">Salvar Fechamento</button>
              <button id="btnCalcTotal" class="btn secondary">Calcular Total</button>
            </div>
            <div class="small" id="cashStatus"></div>
          </div>
        </div>
        <div class="col">
          <div class="card">
            <h3>Hist√≥rico Local de Fechamentos</h3>
            <div class="small">Mantido localmente; tamb√©m √© salvo no servidor se poss√≠vel.</div>
            <div id="cashHistory" class="list" style="margin-top:8px"></div>
          </div>
          <div class="card">
            <h3>Status do Realtime</h3>
            <div class="small">Conex√£o com o canal ‚Äúrealtime-booking‚Äù.</div>
            <div id="rtStatus" class="small">Desconectado</div>
          </div>
        </div>
      </div>
    </section>

    <!-- RELAT√ìRIOS -->
    <section id="tab-relatorios" class="tab-panel" style="display:none">
      <div class="card">
        <h3>Relat√≥rios</h3>
        <p class="small">Espa√ßo para futuros relat√≥rios: volume di√°rio, ticket m√©dio, ranking por barbeiro, etc.</p>
        <div class="warning-box">
          Ainda n√£o conectado aos dados do servidor. Podemos listar os fechamentos di√°rios do Supabase com filtros (salon_id, data) e realtime.
        </div>
      </div>
    </section>

    <!-- CONFIG -->
    <section id="tab-config" class="tab-panel" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>Configura√ß√£o do Supabase</h3>
          <p class="small">Defina a URL do projeto e a anon key. Isso ficar√° em localStorage.</p>
          <div class="row">
            <div class="col">
              <label>Project URL</label>
              <input id="cfgSupabaseUrl" class="input" placeholder="https://xxxxx.supabase.co"/>
            </div>
            <div class="col">
              <label>Anon Key</label>
              <input id="cfgSupabaseAnon" class="input" placeholder="eyJhbGciOi..."/>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveSupabaseCfg" class="btn">Salvar Config</button>
            <button id="btnClearSupabaseCfg" class="btn secondary">Limpar</button>
          </div>
          <div class="hr"></div>
          <div class="ok-box">
            Dica: se estiver com dificuldade de login, voc√™ pode colar a URL e a Anon key direto aqui, salvar e recarregar a p√°gina.
          </div>
        </div>
        <div class="card">
          <h3>Tenant / MASTER</h3>
          <div class="row">
            <div class="col">
              <label>Tenant atual</label>
              <input id="cfgTenant" class="input" placeholder="default"/>
            </div>
            <div class="col">
              <label>Modo</label>
              <select id="cfgMode" class="input">
                <option value="tenant">Tenant</option>
                <option value="master">MASTER</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveTenantCfg" class="btn">Salvar Tenant/Modo</button>
          </div>
          <div class="hr"></div>
          <div class="small">Essas configs influenciam filtros e visuais. O canal de realtime √© √∫nico.</div>
        </div>
      </div>
    </section>

    <!-- DEBUG -->
    <section id="tab-debug" class="tab-panel" style="display:none">
      <div class="card">
        <h3>Debug</h3>
        <div class="row">
          <button id="btnShowLocalStorage" class="btn secondary">Mostrar localStorage</button>
          <button id="btnClearLocalStorage" class="btn danger">Limpar localStorage</button>
        </div>
        <div class="hr"></div>
        <pre id="debugOut" class="mono small" style="white-space: pre-wrap;"></pre>
      </div>
    </section>
  </div>

  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
    // -------------------------
    // Util de Config e Estado
    // -------------------------
    const LS_KEYS = {
      supabaseUrl: 'bb_cfg_supabase_url',
      supabaseAnon: 'bb_cfg_supabase_anon',
      tenant: 'bb_cfg_tenant',
      mode: 'bb_cfg_mode',
      sales: 'bb_sales_today',
      cash: 'bb_cash_history'
    };

    function getCfg(key, def='') {
      try { return localStorage.getItem(key) ?? def; } catch(e) { return def; }
    }
    function setCfg(key, val) {
      try { localStorage.setItem(key, val); } catch(e) {}
    }
    function delCfg(key) {
      try { localStorage.removeItem(key); } catch(e) {}
    }

    function nowIso() {
      return new Date().toISOString();
    }

    function getTenant() {
      return getCfg(LS_KEYS.tenant, 'default') || 'default';
    }
    function setTenant(val) {
      setCfg(LS_KEYS.tenant, val || 'default');
      document.getElementById('tenantName').textContent = getTenant();
    }
    function getMode() {
      return getCfg(LS_KEYS.mode, 'tenant') || 'tenant';
    }
    function setMode(val) {
      setCfg(LS_KEYS.mode, val || 'tenant');
    }

    // -------------------------
    // Supabase Client
    // -------------------------
    let _supabase = null;
    function sb() {
      if (_supabase) return _supabase;
      const url = getCfg(LS_KEYS.supabaseUrl, '');
      const anon = getCfg(LS_KEYS.supabaseAnon, '');
      if (!url || !anon) return null;
      _supabase = window.supabase.createClient(url, anon, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });
      return _supabase;
    }

    // -------------------------
    // Abas
    // -------------------------
    const tabsEl = document.getElementById('tabs');
    const panels = {
      auth: document.getElementById('tab-auth'),
      agenda: document.getElementById('tab-agenda'),
      vendas: document.getElementById('tab-vendas'),
      caixa: document.getElementById('tab-caixa'),
      relatorios: document.getElementById('tab-relatorios'),
      config: document.getElementById('tab-config'),
      debug: document.getElementById('tab-debug')
    };
    tabsEl.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab');
      if (!btn) return;
      const tab = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      Object.entries(panels).forEach(([k, el]) => {
        el.style.display = (k === tab) ? 'block' : 'none';
      });
    });

    // -------------------------
    // AUTH UI
    // -------------------------
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const doLoginBtn = document.getElementById('doLogin');
    const doSignupBtn = document.getElementById('doSignup');
    const doMagicLinkBtn = document.getElementById('doMagicLink');
    const authSessionEl = document.getElementById('authSession');

    async function refreshAuthUI() {
      const client = sb();
      if (!client) {
        btnLogin.style.display = '';
        btnLogout.style.display = 'none';
        authSessionEl.textContent = 'Supabase n√£o configurado.';
        return;
      }
      const { data: { session } } = await client.auth.getSession();
      if (session) {
        btnLogin.style.display = 'none';
        btnLogout.style.display = '';
        authSessionEl.textContent = JSON.stringify({
          user: session.user?.email,
          user_id: session.user?.id,
          expires_at: session.expires_at
        }, null, 2);
      } else {
        btnLogin.style.display = '';
        btnLogout.style.display = 'none';
        authSessionEl.textContent = 'Sem sess√£o.';
      }
    }

    btnLogin.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const client = sb();
      if (!client) return alert('Configure o Supabase em Configura√ß√µes.');
      if (!email || !password) return alert('Informe e-mail e senha.');
      const { error } = await client.auth.signInWithPassword({ email, password });
      if (error) alert('Erro no login: ' + error.message);
      await refreshAuthUI();
      await loadProfileUI();
    });

    btnLogout.addEventListener('click', async () => {
      const client = sb();
      if (client) await client.auth.signOut();
      await refreshAuthUI();
    });

    doLoginBtn.addEventListener('click', () => btnLogin.click());
    doSignupBtn.addEventListener('click', async () => {
      const client = sb();
      if (!client) return alert('Configure o Supabase em Configura√ß√µes.');
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) return alert('Informe e-mail e senha.');
      const { error } = await client.auth.signUp({ email, password });
      if (error) alert('Erro no signup: ' + error.message);
      else alert('Cadastro realizado. Verifique seu e-mail se confirma√ß√£o estiver ativa.');
    });
    doMagicLinkBtn.addEventListener('click', async () => {
      const client = sb();
      if (!client) return alert('Configure o Supabase em Configura√ß√µes.');
      const email = document.getElementById('email').value.trim();
      if (!email) return alert('Informe o e-mail.');
      const { error } = await client.auth.signInWithOtp({ email });
      if (error) alert('Erro no magic link: ' + error.message);
      else alert('Magic link enviado (se habilitado).');
    });

    // -------------------------
    // Perfil
    // -------------------------
    const btnEnsureProfile = document.getElementById('btnEnsureProfile');
    const btnLoadProfile = document.getElementById('btnLoadProfile');
    const profileResult = document.getElementById('profileResult');

    async function getMySalonIdFromProfiles() {
      const client = sb();
      if (!client) throw new Error('Supabase n√£o configurado.');
      const { data: { user } } = await client.auth.getUser();
      if (!user) throw new Error('Sem usu√°rio');
      // CORRE√á√ÉO APLICADA AQUI: buscar por user_id
      const { data, error } = await client
        .from('profiles')
        .select('salon_id')
        .eq('user_id', user.id)
        .single();
      if (error) throw error;
      return data?.salon_id ?? null;
    }

    async function ensureProfile() {
      const client = sb();
      if (!client) {
        profileResult.textContent = 'Supabase n√£o configurado.';
        return;
      }
      const { data: { user } } = await client.auth.getUser();
      if (!user) {
        profileResult.textContent = 'Fa√ßa login primeiro.';
        return;
      }
      const full_name = (document.getElementById('profileFullName').value || '').trim();
      const role = (document.getElementById('profileRole').value || '').trim();
      const salon_id = (document.getElementById('profileSalonId').value || '').trim() || null;

      // upsert por user_id
      const payload = { user_id: user.id, full_name: full_name || null, role: role || null, salon_id };
      const { data, error } = await client
        .from('profiles')
        .upsert(payload, { onConflict: 'user_id' })
        .select('*')
        .maybeSingle();

      if (error) {
        profileResult.textContent = 'Erro: ' + error.message;
      } else {
        profileResult.textContent = 'OK: ' + JSON.stringify(data, null, 2);
        document.getElementById('profileUserId').value = user.id;
      }
    }

    async function loadProfileUI() {
      const client = sb();
      if (!client) {
        profileResult.textContent = 'Supabase n√£o configurado.';
        return;
      }
      const { data: { user } } = await client.auth.getUser();
      if (!user) {
        profileResult.textContent = 'Sem usu√°rio.';
        return;
      }
      const { data, error } = await client
        .from('profiles')
        .select('*')
        .eq('user_id', user.id) // coerente com a corre√ß√£o
        .maybeSingle();
      if (error) {
        profileResult.textContent = 'Erro carregando: ' + error.message;
      } else {
        profileResult.textContent = 'Perfil: ' + JSON.stringify(data, null, 2);
        if (data) {
          document.getElementById('profileFullName').value = data.full_name ?? '';
          document.getElementById('profileRole').value = data.role ?? '';
          document.getElementById('profileSalonId').value = data.salon_id ?? '';
          document.getElementById('profileUserId').value = data.user_id ?? '';
        }
      }
    }

    btnEnsureProfile.addEventListener('click', ensureProfile);
    btnLoadProfile.addEventListener('click', loadProfileUI);

    // -------------------------
    // Agenda (local + realtime)
    // -------------------------
    const appointmentRequestsEl = document.getElementById('appointmentRequests');
    const appointmentsListEl = document.getElementById('appointmentsList');
    const reqStatusEl = document.getElementById('reqStatus');

    let appointmentRequests = []; // local
    let appointments = [];        // local

    function renderAppointmentRequests() {
      appointmentRequestsEl.innerHTML = '';
      appointmentRequests.forEach((r, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div><span class="status-dot online"></span><strong>${r.name || ''}</strong> - ${r.service || ''}</div>
          <div class="small">${r.when || ''} | ${r.obs || ''}</div>
          <div class="small">id: <code class="inline">${r.id || idx}</code></div>
        `;
        appointmentRequestsEl.appendChild(div);
      });
    }

    function renderAppointments() {
      appointmentsListEl.innerHTML = '';
      appointments.forEach((a, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div><span class="status-dot ${a.status === 'confirmed' ? 'online' : 'offline'}"></span>
            <strong>${a.customer || ''}</strong> - ${a.service || ''}</div>
          <div class="small">${a.when || ''} | Prof: ${a.barber || '-'}</div>
          <div class="small">status: ${a.status || 'pending'} | id: <code class="inline">${a.id || idx}</code></div>
        `;
        appointmentsListEl.appendChild(div);
      });
    }

    document.getElementById('btnSendAppointmentRequest').addEventListener('click', async () => {
      const name = document.getElementById('reqName').value.trim();
      const service = document.getElementById('reqService').value.trim();
      const when = document.getElementById('reqWhen').value;
      const obs = document.getElementById('reqObs').value.trim();
      if (!name || !service || !when) {
        reqStatusEl.textContent = 'Preencha nome, servi√ßo e data/hora.';
        return;
      }
      // Local append para demo
      const req = { id: 'local-' + Date.now(), name, service, when, obs, tenant: getTenant(), created_at: nowIso() };
      appointmentRequests.unshift(req);
      renderAppointmentRequests();

      // Notificar via Realtime (se conectado)
      try {
        const client = sb();
        if (!client) return;
        await client.channel('realtime-booking').send({
          type: 'broadcast',
          event: 'appointment_request',
          payload: req
        });
        reqStatusEl.textContent = 'Pedido enviado (broadcast).';
      } catch (e) {
        reqStatusEl.textContent = 'Enviado localmente, realtime indispon√≠vel.';
      }
    });

    // -------------------------
    // Vendas (local)
    // -------------------------
    function loadSales() {
      try {
        const raw = getCfg(LS_KEYS.sales, '[]');
        return JSON.parse(raw);
      } catch(e) { return []; }
    }
    function saveSales(items) {
      setCfg(LS_KEYS.sales, JSON.stringify(items || []));
    }
    function renderSales() {
      const container = document.getElementById('salesToday');
      const sales = loadSales();
      container.innerHTML = '';
      sales.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div><strong>${s.customer || ''}</strong> - ${s.item || ''}</div>
          <div class="small">R$ ${Number(s.amount || 0).toFixed(2)} | ${s.payment || ''} | ${s.when || ''}</div>
          <div class="small">id: <code class="inline">${s.id || idx}</code></div>
        `;
        container.appendChild(div);
      });
    }
    document.getElementById('btnAddSale').addEventListener('click', () => {
      const customer = document.getElementById('saleCustomer').value.trim();
      const item = document.getElementById('saleItem').value.trim();
      const amount = parseFloat(document.getElementById('saleAmount').value || '0');
      const payment = document.getElementById('salePayment').value;
      const saleStatus = document.getElementById('saleStatus');

      if (!customer || !item || !(amount > 0)) {
        saleStatus.textContent = 'Preencha cliente, item e valor > 0.';
        return;
      }
      const sales = loadSales();
      sales.unshift({
        id: 'sale-' + Date.now(),
        customer, item, amount, payment,
        when: new Date().toLocaleString(),
        tenant: getTenant()
      });
      saveSales(sales);
      renderSales();
      saleStatus.textContent = 'Venda registrada localmente.';
    });

    // -------------------------
    // Caixa (local + supabase)
    // -------------------------
    function loadCashHistory() {
      try {
        const raw = getCfg(LS_KEYS.cash, '[]');
        return JSON.parse(raw);
      } catch(e) { return []; }
    }
    function saveCashHistory(items) {
      setCfg(LS_KEYS.cash, JSON.stringify(items || []));
    }
    function renderCashHistory() {
      const container = document.getElementById('cashHistory');
      const items = loadCashHistory();
      container.innerHTML = '';
      items.forEach((c, idx) => {
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div><strong>${c.date_yyyy_mm_dd || ''}</strong> ‚Äî Total R$ ${Number(c.total || 0).toFixed(2)}</div>
          <div class="small">op: ${c.operator_email || ''} | ${c.qtde || 0} atend.</div>
          <div class="small">pix: ${Number(c.pix||0).toFixed(2)} | d√©bito: ${Number(c.debito||0).toFixed(2)} | cr√©dito: ${Number(c.credito||0).toFixed(2)} | dinheiro: ${Number(c.dinheiro||0).toFixed(2)}</div>
          <div class="small">itens: ${Array.isArray(c.itens) ? c.itens.length : 0} | id: <code class="inline">${c.id || idx}</code></div>
        `;
        container.appendChild(div);
      });
    }

    document.getElementById('btnCalcTotal').addEventListener('click', () => {
      const d = parseFloat(document.getElementById('cashDinheiro').value || '0');
      const p = parseFloat(document.getElementById('cashPix').value || '0');
      const db = parseFloat(document.getElementById('cashDebito').value || '0');
      const cr = parseFloat(document.getElementById('cashCredito').value || '0');
      document.getElementById('cashTotal').value = (d + p + db + cr).toFixed(2);
    });

    document.getElementById('btnSaveCashClose').addEventListener('click', async () => {
      const cashStatus = document.getElementById('cashStatus');
      try {
        const date_yyyy_mm_dd = document.getElementById('cashDate').value;
        const operator_email = document.getElementById('cashOperator').value.trim();
        const qtde = parseInt(document.getElementById('cashQtde').value || '0', 10);
        const pix = parseFloat(document.getElementById('cashPix').value || '0');
        const debito = parseFloat(document.getElementById('cashDebito').value || '0');
        const credito = parseFloat(document.getElementById('cashCredito').value || '0');
        const dinheiro = parseFloat(document.getElementById('cashDinheiro').value || '0');
        const total = parseFloat(document.getElementById('cashTotal').value || '0');

        let itens = [];
        const itensRaw = document.getElementById('cashItens').value.trim();
        if (itensRaw) {
          try { itens = JSON.parse(itensRaw); } catch(e) { itens = []; }
        }

        if (!date_yyyy_mm_dd) throw new Error('Informe a data do fechamento.');
        if (!operator_email) throw new Error('Informe o e-mail do operador.');

        const closeObj = {
          id: 'close-' + Date.now(),
          date_yyyy_mm_dd, operator_email, qtde, pix, debito, credito, dinheiro, total,
          itens, when: nowIso(), tenant: getTenant()
        };

        // Salvar localmente
        const history = loadCashHistory();
        history.unshift(closeObj);
        saveCashHistory(history);
        renderCashHistory();

        // Tentar salvar no Supabase
        const client = sb();
        if (client) {
          try {
            const { data: { user } } = await client.auth.getUser();
            if (!user) throw new Error('Sem usu√°rio logado para salvar no servidor.');
            // Pegar salon_id do perfil do usu√°rio (usando a fun√ß√£o corrigida)
            const salon_id = await getMySalonIdFromProfiles();

            const payload = {
              salon_id,
              operator_id: user.id,
              operator_email: operator_email,
              date_yyyy_mm_dd: date_yyyy_mm_dd,
              nome_cliente: null,
              qtde,
              pix, debito, credito, dinheiro, total,
              itens
            };

            const { error } = await client.from('caixa_fechamentos').insert(payload);
            if (error) throw error;

            // Broadcast realtime opcional
            await client.channel('realtime-booking').send({
              type: 'broadcast',
              event: 'cash_close',
              payload: { ...payload, when: nowIso(), tenant: getTenant() }
            });

            cashStatus.textContent = 'Fechamento salvo local e no servidor.';
          } catch (e) {
            cashStatus.textContent = 'Fechamento salvo local. Erro ao salvar no servidor: ' + (e.message || e);
          }
        } else {
          cashStatus.textContent = 'Fechamento salvo local. Configure Supabase para salvar no servidor.';
        }
      } catch (e) {
        cashStatus.textContent = 'Erro: ' + (e.message || e);
      }
    });

    // -------------------------
    // Realtime
    // -------------------------
    let rtChannel = null;
    const rtStatusEl = document.getElementById('rtStatus');

    function setupRealtime() {
      const client = sb();
      if (!client) {
        rtStatusEl.textContent = 'Desconectado (Supabase n√£o configurado).';
        return;
      }
      if (rtChannel) {
        try { client.removeChannel(rtChannel); } catch(e) {}
        rtChannel = null;
      }
      rtChannel = client.channel('realtime-booking', { config: { broadcast: { ack: true } } });

      rtChannel.on('broadcast', { event: 'appointment_request' }, ({ payload }) => {
        // Receber pedidos
        if (payload?.tenant && payload.tenant !== getTenant() && getMode() !== 'master') return;
        appointmentRequests.unshift(payload);
        renderAppointmentRequests();
      });

      rtChannel.on('broadcast', { event: 'appointment_confirmed' }, ({ payload }) => {
        if (payload?.tenant && payload.tenant !== getTenant() && getMode() !== 'master') return;
        appointments.unshift({ ...payload, status: 'confirmed' });
        renderAppointments();
      });

      rtChannel.on('broadcast', { event: 'cash_close' }, ({ payload }) => {
        if (payload?.tenant && payload.tenant !== getTenant() && getMode() !== 'master') return;
        // Apenas feedback visual para gerente acompanhar
        const div = document.createElement('div');
        div.className = 'list-item';
        div.innerHTML = `
          <div><strong>Fechamento recebido</strong> ‚Äî Total R$ ${Number(payload?.total || 0).toFixed(2)}</div>
          <div class="small">${payload?.date_yyyy_mm_dd || ''} | op: ${payload?.operator_email || ''}</div>
        `;
        // Mostra em "Agenda do Dia" como um evento informativo (ou crie uma √°rea pr√≥pria)
        appointmentsListEl.prepend(div);
      });

      rtChannel.subscribe((status) => {
        if (status === 'SUBSCRIBED') rtStatusEl.textContent = 'Conectado ao canal.';
        else rtStatusEl.textContent = 'Status: ' + status;
      });
    }

    // -------------------------
    // Config Supabase
    // -------------------------
    document.getElementById('btnSaveSupabaseCfg').addEventListener('click', () => {
      const url = document.getElementById('cfgSupabaseUrl').value.trim();
      const anon = document.getElementById('cfgSupabaseAnon').value.trim();
      if (!url || !anon) return alert('Informe URL e Anon Key.');
      setCfg(LS_KEYS.supabaseUrl, url);
      setCfg(LS_KEYS.supabaseAnon, anon);
      _supabase = null; // reset
      setupRealtime();
      refreshAuthUI();
      alert('Configura√ß√µes salvas.');
    });
    document.getElementById('btnClearSupabaseCfg').addEventListener('click', () => {
      delCfg(LS_KEYS.supabaseUrl);
      delCfg(LS_KEYS.supabaseAnon);
      _supabase = null;
      setupRealtime();
      refreshAuthUI();
      alert('Config limpa.');
    });

    document.getElementById('btnSaveTenantCfg').addEventListener('click', () => {
      const t = document.getElementById('cfgTenant').value.trim() || 'default';
      const m = document.getElementById('cfgMode').value;
      setTenant(t);
      setMode(m);
      // Reinscrever realtime
      setupRealtime();
      alert('Tenant/Modo salvos.');
    });

    document.getElementById('btnSwitchTenant').addEventListener('click', () => {
      const cur = getTenant();
      const next = prompt('Novo tenant:', cur) || cur;
      setTenant(next);
      document.getElementById('cfgTenant').value = next;
      setupRealtime();
    });

    document.getElementById('btnConfig').addEventListener('click', () => {
      document.querySelector('.tab[data-tab="config"]').click();
    });

    // -------------------------
    // Debug
    // -------------------------
    document.getElementById('btnShowLocalStorage').addEventListener('click', () => {
      const dump = {};
      for (let i=0; i<localStorage.length;i++){
        const k = localStorage.key(i);
        dump[k] = localStorage.getItem(k);
      }
      document.getElementById('debugOut').textContent = JSON.stringify(dump, null, 2);
    });
    document.getElementById('btnClearLocalStorage').addEventListener('click', () => {
      if (!confirm('Tem certeza que deseja limpar todo o localStorage?')) return;
      localStorage.clear();
      document.getElementById('debugOut').textContent = 'localStorage limpo.';
    });

    // -------------------------
    // Bootstrap
    // -------------------------
    function bootstrap() {
      // Preenche badges e inputs config
      document.getElementById('tenantName').textContent = getTenant();
      document.getElementById('cfgTenant').value = getTenant();
      document.getElementById('cfgMode').value = getMode();

      document.getElementById('cfgSupabaseUrl').value = getCfg(LS_KEYS.supabaseUrl, '');
      document.getElementById('cfgSupabaseAnon').value = getCfg(LS_KEYS.supabaseAnon, '');

      renderSales();
      renderCashHistory();
      renderAppointmentRequests();
      renderAppointments();

      setupRealtime();
      refreshAuthUI();
      loadProfileUI();
    }

    bootstrap();
  </script>
</body>
</html>